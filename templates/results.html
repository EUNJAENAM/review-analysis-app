{% extends "base.html" %}

{% block title %}분석 결과 - 오색그린야드호텔 리뷰 분석{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-chart-line me-2 text-primary"></i>
                분석 결과
            </h2>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-home me-2"></i>새로운 분석
                </a>
                <!-- 다운로드 버튼들 -->
                <div class="d-flex justify-content-end mt-4">
                    <!-- 현재 간소화된 버전에서는 리포트 다운로드를 지원하지 않습니다 -->
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        현재 버전에서는 분석 결과를 웹 페이지에서 직접 확인할 수 있습니다. 
                        리포트 다운로드 기능은 향후 업데이트에서 제공될 예정입니다.
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="kpi-card">
                    <h3 class="mb-2">{{ session_info.summary.total_reviews }}</h3>
                    <p class="mb-0">총 리뷰 수</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card">
                    <h3 class="mb-2">{{ "%.2f"|format(session_info.summary.average_rating) }}</h3>
                    <p class="mb-0">평균 평점</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card">
                    <h3 class="mb-2">{{ "%.2f"|format(session_info.summary.positive_ratio) }}%</h3>
                    <p class="mb-0">긍정 비율</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="kpi-card">
                    <h3 class="mb-2">{{ session_info.summary.top_priority }}</h3>
                    <p class="mb-0">최우선 개선사항</p>
                </div>
            </div>
        </div>

        <!-- 분석 결과 섹션 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>분석 결과 요약
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>기본 통계</h6>
                                <ul class="list-unstyled">
                                    <li><strong>총 리뷰 수:</strong> {{ session_info.summary.total_reviews }}개</li>
                                    <li><strong>평균 평점:</strong> {{ "%.2f"|format(session_info.summary.average_rating) }}점</li>
                                    <li><strong>데이터 기간:</strong> {{ session_info.summary.data_period }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>감정 분석</h6>
                                <ul class="list-unstyled">
                                    <li><strong>긍정:</strong> {{ "%.2f"|format(session_info.summary.positive_ratio) }}%</li>
                                    <li><strong>부정:</strong> {{ "%.2f"|format(session_info.summary.negative_ratio) }}%</li>
                                    <li><strong>중립:</strong> {{ "%.2f"|format(session_info.summary.neutral_ratio) }}%</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- 주요 인사이트 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>주요 인사이트</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">전체 감정</h6>
                                                <span class="badge {% if session_info.summary.key_insights.overall_sentiment == '긍정' %}bg-success{% elif session_info.summary.key_insights.overall_sentiment == '부정' %}bg-danger{% else %}bg-warning{% endif %}">
                                                    {{ session_info.summary.key_insights.overall_sentiment }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">주요 강점</h6>
                                                <small>{{ session_info.summary.key_insights.main_strength }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-danger text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">주요 약점</h6>
                                                <small>{{ session_info.summary.key_insights.main_weakness }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 개선사항 우선순위 점수 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>개선사항 우선순위 점수</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>항목</th>
                                                <th>우선순위 점수</th>
                                                <th>부정 비율</th>
                                                <th>언급 횟수</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for aspect, score in session_info.summary.priority_scores.items() %}
                                            <tr>
                                                <td>{{ aspect }}</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-danger" style="width: {{ score }}%">{{ score }}</div>
                                                    </div>
                                                </td>
                                                <td>{{ session_info.summary.aspect_sentiment[aspect].negative_ratio }}%</td>
                                                <td>{{ session_info.summary.aspect_sentiment[aspect].total }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aspect별 감정분포 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Aspect별 감정분포</h6>
                                <div class="row">
                                    {% for aspect, sentiment in session_info.summary.aspect_sentiment.items() %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">{{ aspect }}</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <div class="text-success">
                                                            <i class="fas fa-thumbs-up"></i>
                                                            <div>{{ sentiment.positive_ratio }}%</div>
                                                            <small>긍정</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="text-warning">
                                                            <i class="fas fa-minus"></i>
                                                            <div>{{ sentiment.neutral_ratio }}%</div>
                                                            <small>중립</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="text-danger">
                                                            <i class="fas fa-thumbs-down"></i>
                                                            <div>{{ sentiment.negative_ratio }}%</div>
                                                            <small>부정</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 전략적 제어 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>전략적 제어</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">즉시 조치</h6>
                                                <small>{{ session_info.summary.strategic_recommendations.immediate_action }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">장기 집중</h6>
                                                <small>{{ session_info.summary.strategic_recommendations.long_term_focus }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="card bg-warning text-dark">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">우선순위</h6>
                                                <span class="badge {% if session_info.summary.strategic_recommendations.priority_level == '높음' %}bg-danger{% elif session_info.summary.strategic_recommendations.priority_level == '중간' %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ session_info.summary.strategic_recommendations.priority_level }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 결론 및 향후 방향 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>결론 및 향후 방향</h6>
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-chart-line me-2"></i>개선 잠재력</h6>
                                    <p class="mb-2">약 {{ session_info.summary.key_insights.improvement_potential }}명의 고객 만족도 향상 가능</p>
                                    
                                    <h6><i class="fas fa-target me-2"></i>핵심 목표</h6>
                                    <p class="mb-2">{{ session_info.summary.strategic_recommendations.immediate_action }} 분야 개선을 통한 고객 만족도 증대</p>
                                    
                                    <h6><i class="fas fa-road me-2"></i>실행 방안</h6>
                                    <ul class="mb-0">
                                        <li>고객 피드백 기반 개선 계획 수립</li>
                                        <li>직원 교육 및 서비스 품질 향상</li>
                                        <li>정기적인 만족도 모니터링 체계 구축</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 차트 섹션 -->
                        {% if session_info.summary.charts %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>시각화 차트</h6>
                                <div class="row">
                                    {% if 'sentiment' in session_info.summary.charts %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>감정 분포</h6>
                                                <img src="/api/plot/{{ session_id }}/sentiment" class="img-fluid" alt="감정 분포">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if 'trend' in session_info.summary.charts %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>연도별 트렌드</h6>
                                                <img src="/api/plot/{{ session_id }}/trend" class="img-fluid" alt="연도별 트렌드">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if 'keywords' in session_info.summary.charts %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>부정 키워드</h6>
                                                <img src="/api/plot/{{ session_id }}/keywords" class="img-fluid" alt="부정 키워드">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>차트 생성 안내:</strong> 
                            차트 생성 중 오류가 발생했거나 데이터가 부족합니다. 
                            텍스트 분석 결과를 참고해주세요.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 추가 분석 정보 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            분석 정보
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6>데이터 기간</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-calendar me-2"></i>
                                    {{ session_info.summary.data_period }}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6>생성된 차트</h6>
                                <div class="alert alert-success">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    {% if session_info.summary.charts %}
                                        {% for chart_name in session_info.summary.charts.keys() %}
                                            <span class="badge bg-primary me-1">{{ chart_name }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">생성된 차트 없음</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>분석 완료 시간</h6>
                                <div class="alert alert-light">
                                    <i class="fas fa-clock me-2"></i>
                                    {{ session_info.created_at[:19].replace('T', ' ') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Company Name -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="text-end">
                <small class="text-muted">
                    <strong>(주)파로스</strong>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 이미지 로드 실패 시 처리
    $('img').on('error', function() {
        $(this).replaceWith('<div class="alert alert-warning">이미지를 불러올 수 없습니다.</div>');
    });
});
</script>
{% endblock %}
