{% extends "base.html" %}

{% block title %}분석 진행 중 - 오색그린야드호텔 리뷰 분석{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Analysis Progress -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    분석 진행 중
                </h4>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">분석 중...</span>
                    </div>
                    <h5>리뷰 데이터를 분석하고 있습니다</h5>
                    <p class="text-muted">잠시만 기다려주세요. 분석이 완료되면 자동으로 결과 페이지로 이동합니다.</p>
                </div>

                <!-- Progress Steps -->
                <div class="progress-steps mb-4">
                    <div class="step active" id="step1">
                        <div class="step-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="step-content">
                            <h6>데이터 로드</h6>
                            <small>CSV 파일 읽기 및 전처리</small>
                        </div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="step-content">
                            <h6>기본 분석</h6>
                            <small>KPI, 감정분석, Aspect 분석</small>
                        </div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="step-content">
                            <h6>고급 분석</h6>
                            <small>예측 모델, 토픽 모델링</small>
                        </div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="step-content">
                            <h6>시각화</h6>
                            <small>그래프 및 리포트 생성</small>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar">
                        0%
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusMessages" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="currentStatus">분석을 시작합니다...</span>
                </div>

                <!-- Results Link (Hidden initially) -->
                <div id="resultsLink" class="alert alert-success" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">분석이 완료되었습니다!</h6>
                            <p class="mb-2">아래 버튼을 클릭하여 상세한 분석 결과를 확인하세요.</p>
                            <a href="#" id="viewResultsBtn" class="btn btn-success">
                                <i class="fas fa-chart-bar me-2"></i>
                                분석 결과 보기
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Analysis Options -->
                <div class="alert alert-secondary">
                    <h6><i class="fas fa-cog me-2"></i>분석 설정</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>고급 분석:</strong> 
                                <span class="badge bg-{{ 'success' if enable_advanced else 'secondary' }}">
                                    {{ '활성화' if enable_advanced else '비활성화' }}
                                </span>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>세션 ID:</strong> {{ session_id }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel Button -->
        <div class="text-center mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-2"></i>
                분석 취소
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.progress-steps {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
}

.step {
    display: flex;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 1.5rem;
    left: 2.5rem;
    right: -1rem;
    height: 2px;
    background-color: #e9ecef;
    z-index: 1;
}

.step.active:not(:last-child)::after {
    background-color: #4682B4;
}

.step-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    z-index: 2;
    position: relative;
}

.step.active .step-icon {
    background-color: #4682B4;
    color: white;
}

.step.completed .step-icon {
    background-color: #28a745;
    color: white;
}

.step-content h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
}

.step-content small {
    color: #6c757d;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const sessionId = '{{ session_id }}';
    const enableAdvanced = {{ 'true' if enable_advanced else 'false' }};
    
    let currentStep = 1;
    let progress = 0;
    
    // 분석 시작
    startAnalysis();
    
    function startAnalysis() {
        $.ajax({
            url: `/api/analyze/${sessionId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                enable_advanced: enableAdvanced
            }),
            timeout: 300000, // 5분 타임아웃
            success: function(response) {
                if (response.success) {
                    updateProgress(100, '분석 완료!');
                    updateStep(4, 'completed');
                    
                    // 결과 링크 표시
                    showResultsLink();
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = '분석 중 오류가 발생했습니다.';
                
                if (status === 'timeout') {
                    errorMessage = '분석 시간이 초과되었습니다. 데이터 크기를 줄이거나 고급 분석을 비활성화해주세요.';
                } else if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                
                $('#currentStatus').html(`<span class="text-danger">${errorMessage}</span>`);
                $('#statusMessages').removeClass('alert-info').addClass('alert-danger');
                
                // 재시도 버튼 추가
                $('#statusMessages').append(`
                    <div class="mt-3">
                        <button class="btn btn-warning btn-sm" onclick="retryAnalysis()">
                            <i class="fas fa-redo me-2"></i>다시 시도
                        </button>
                        <a href="/" class="btn btn-secondary btn-sm ms-2">
                            <i class="fas fa-home me-2"></i>홈으로
                        </a>
                    </div>
                `);
            }
        });
        
        // 진행 상황 시뮬레이션
        simulateProgress();
    }
    
    function retryAnalysis() {
        location.reload();
    }
    
    function simulateProgress() {
        const steps = [
            { progress: 40, status: '데이터를 로드하고 전처리 중입니다...', step: 1 },
            { progress: 70, status: '기본 분석을 수행 중입니다...', step: 2 },
            { progress: 90, status: enableAdvanced ? '고급 분석을 수행 중입니다...' : '시각화를 생성 중입니다...', step: 3 },
            { progress: 98, status: '리포트를 생성 중입니다...', step: 4 },
            { progress: 100, status: '완료!', step: 4 }
        ];
        
        let stepIndex = 0;
        const interval = setInterval(function() {
            if (stepIndex < steps.length) {
                const step = steps[stepIndex];
                updateProgress(step.progress, step.status);
                updateStep(step.step, 'active');
                
                if (stepIndex > 0) {
                    updateStep(steps[stepIndex - 1].step, 'completed');
                }
                
                stepIndex++;
            } else {
                clearInterval(interval);
            }
        }, 200); // 0.2초로 단축
        }
    
    function updateProgress(percent, status) {
        progress = percent;
        $('#progressBar').css('width', percent + '%').text(percent + '%');
        $('#currentStatus').text(status);
    }
    
    function updateStep(stepNumber, status) {
        const step = $(`#step${stepNumber}`);
        step.removeClass('active completed').addClass(status);
    }
    
    function showResultsLink() {
        // 상태 메시지 숨기기
        $('#statusMessages').hide();
        
        // 결과 링크 표시
        $('#resultsLink').show();
        
        // 결과 버튼에 링크 설정
        $('#viewResultsBtn').attr('href', `/results/${sessionId}`);
        
        // 5초 후 자동 이동 알림 (선택사항)
        setTimeout(function() {
            const shouldRedirect = confirm('분석이 완료되었습니다!\n\n결과 페이지로 자동 이동하시겠습니까?\n\n취소하시면 현재 페이지에서 결과 링크를 클릭하실 수 있습니다.');
            if (shouldRedirect) {
                window.location.href = `/results/${sessionId}`;
            }
        }, 5000);
    }
});
</script>
{% endblock %}
